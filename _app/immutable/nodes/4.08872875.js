var z=Object.defineProperty;var F=(s,e,t)=>e in s?z(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var p=(s,e,t)=>(F(s,typeof e!="symbol"?e+"":e,t),t);import{S as G,i as Q,s as Y,k as _,q,a as C,l as y,m as x,r as j,h as c,c as O,n as h,b,C as f,D as P,o as Z}from"../chunks/index.c24d3119.js";class k{constructor(e,t){p(this,"value");p(this,"subscribers");p(this,"key");p(this,"hash");localStorage.getItem(e)===null?localStorage.setItem(e,JSON.stringify(t)):t=JSON.parse(localStorage.getItem(e)),this.value=t,this.subscribers=[],this.key=e,this.hash=JSON.stringify(t)}set(e){this.hash!=JSON.stringify(e)&&(this.value=e,localStorage.setItem(this.key,JSON.stringify(e)),this.subscribers.forEach(t=>t(e)))}subscribe(e){this.subscribers.push(e)}update(e){this.set(e(this.value))}}const V="https://chatserver.sciepedia.com/",ee="http://localhost:5000/";let K=V;window.location.hostname==="localhost"&&(K=ee);function te(s,e){return new Promise((a,r)=>{let o=s.map(n=>({content:n.content,role:n.role}));fetch(K+"answer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:o})}).then(n=>{console.log(n);let i=n.body.getReader();function w({done:d,value:T}){if(d){a();return}e(new TextDecoder().decode(T)),i.read().then(w)}i.read().then(w)})})}function se(s){return new Promise((t,a)=>{fetch(K+"embed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:s})}).then(r=>{console.log(r);let o=r.json();t(o)})})}let D,m,R,U,v=new k("last_message",""),$=new k("history",[]);const B=new Map;class L{constructor(e){p(this,"msg");p(this,"element");this.msg=e,this.element=document.createElement("div"),this.element.classList.add("message"),this.element.classList.add(e.value.role),this.setContent(e.value.content),D.appendChild(this.element),e.subscribe(t=>{this.setContent(t.content)})}setContent(e){this.element.innerHTML="";let t=document.createElement("div");t.classList.add("text"),this.element.appendChild(t);let a=0;e.split(`
`).forEach(r=>{if(r.startsWith("```")){a=(a+1)%2,t=document.createElement("div");let o=["text","code"][a];t.classList.add(o),this.element.appendChild(t)}else t.textContent+=r+`
`})}}function N(){return Math.random().toString(36).slice(-8)}function ne(s){new L(new k("M_"+N(),{role:"user",content:s,parent_key:"",key:"",child_keys:[]}));let e=s.slice(1),t=e.split(" ");e=t[0],t.slice(1),new L(new k("M_"+N(),{role:"assistant",content:"Command received: "+e,parent_key:"",key:"",child_keys:[]}))}function X(s){if(s.startsWith("/"))return ne(s);let e="M_"+N(),t=new k(e,{role:"user",content:s,parent_key:v.value,key:e,child_keys:[]});B.set(e,t),new L(t),v.set(e);let a="M_"+N(),r=new k(a,{role:"assistant",content:"...",parent_key:e,key:a,child_keys:[]}),o=[t.value];for(let n=0;n<10;n++){let i=H(o[0].parent_key);if(!i)break;o=[i.value,...o]}te(o,n=>{r.update(i=>(console.log(n),i.content=i.content.slice(0,i.content.length-3)+n+"...",i))}).then(()=>{r.update(n=>(n.content=n.content.slice(0,n.content.length-3),n)),v.set(a)}),new L(r)}function H(s){return s?B.has(s)?B.get(s):new k(s,{role:"system",content:"Message not found",parent_key:"",key:s,child_keys:[]}):null}function le(){if(D=document.querySelector("#chat"),m=document.querySelector("#inputmask>textarea"),R=document.querySelector("#sendbtn"),U=document.querySelector("#resetbtn"),m.addEventListener("keyup",s=>{if(s.key=="Enter"&&s.shiftKey){X(m.value.slice(0,-1)),m.value="";return}m.rows=m.value.split(`
`).length}),v.value){let s=function(t){t!=null&&(s(H(t.value.parent_key)),new L(t))},e=H(v.value);s(e)}R.addEventListener("click",()=>{X(m.value),m.value=""}),U.addEventListener("click",()=>{$.update(s=>s.concat([v.value])),v.set(""),D.innerHTML="",console.log($)})}function re(s){let e,t,a,r,o,n,i,w,d,T,I,S,J,M,g;return{c(){e=_("h1"),t=q("chat"),a=C(),r=_("div"),o=C(),n=_("div"),i=_("textarea"),w=C(),d=_("button"),T=q("send"),I=C(),S=_("button"),J=q("reset"),M=C(),g=_("link"),this.h()},l(l){e=y(l,"H1",{});var u=x(e);t=j(u,"chat"),u.forEach(c),a=O(l),r=y(l,"DIV",{id:!0}),x(r).forEach(c),o=O(l),n=y(l,"DIV",{id:!0});var E=x(n);i=y(E,"TEXTAREA",{id:!0,rows:!0}),x(i).forEach(c),w=O(E),d=y(E,"BUTTON",{id:!0});var W=x(d);T=j(W,"send"),W.forEach(c),I=O(E),S=y(E,"BUTTON",{id:!0});var A=x(S);J=j(A,"reset"),A.forEach(c),E.forEach(c),M=O(l),g=y(l,"LINK",{rel:!0,href:!0}),this.h()},h(){h(r,"id","chat"),h(i,"id",""),h(i,"rows","1"),h(d,"id","sendbtn"),h(S,"id","resetbtn"),h(n,"id","inputmask"),h(g,"rel","stylesheet"),h(g,"href","chatstyle.css")},m(l,u){b(l,e,u),f(e,t),b(l,a,u),b(l,r,u),b(l,o,u),b(l,n,u),f(n,i),f(n,w),f(n,d),f(d,T),f(n,I),f(n,S),f(S,J),b(l,M,u),b(l,g,u)},p:P,i:P,o:P,d(l){l&&c(e),l&&c(a),l&&c(r),l&&c(o),l&&c(n),l&&c(M),l&&c(g)}}}function ie(s){return Z(le),se(["hello"]).then(e=>console.log(e)),[]}class ce extends G{constructor(e){super(),Q(this,e,ie,re,Y,{})}}export{ce as component};
