var De=Object.defineProperty;var Me=(s,t,e)=>t in s?De(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var _=(s,t,e)=>(Me(s,typeof t!="symbol"?t+"":t,e),e);import{J as z,S as fe,i as ge,s as _e,a as A,k as P,q as F,c as W,l as T,m as M,r as q,h as b,n as L,b as C,C as E,K as oe,L as X,D as J,M as Ae,t as we,u as ye,w as We,y as He,N as Ie,z as Oe,O as Re,A as ze,g as je,d as Ue,B as Fe,E as re}from"../chunks/index.c24d3119.js";import{g as H,u as qe,s as N,a as le,i as U,b as ve,c as be,m as ke,d as Ee,P as Le,e as Ve,o as Ke,f as V,h as Be}from"../chunks/data_store.abad8019.js";import{_ as Je}from"../chunks/preload-helper.41c905a7.js";function Ye({fetch:s,params:t}){return{fetch:s}}const Pt=Object.freeze(Object.defineProperty({__proto__:null,load:Ye},Symbol.toStringTag,{value:"Module"}));var $e=s=>new Promise((t,e)=>{console.log("rename_note",s);const n=document.createElement("div");n.classList.add("bg"),n.addEventListener("click",d=>{d.target==n&&(n.remove(),e())}),document.querySelector("#page").appendChild(n);const i=document.createElement("div");i.classList.add("container"),n.appendChild(i);const l=document.createElement("h2");l.innerHTML="rename note";const a=document.createElement("input");a.value=s.tostring();const o=document.createElement("p"),r=()=>{const d=H(a.value);d!=s?(t(d),n.remove()):o.innerHTML="invalid name"};a.addEventListener("keyup",d=>{d.key=="Enter"&&r()});const p=document.createElement("button");p.innerHTML="rename",p.onclick=()=>r(),i.appendChild(l),i.appendChild(a),i.appendChild(o),i.appendChild(document.createElement("br")),i.appendChild(p)});function Xe(s,t){s.preventDefault();let e=document.createElement("div");e.style.position="fixed",e.style.top=s.pageY-window.scrollY+"px",e.style.left=s.pageX+"px",e.style.backgroundColor="var(--focus)",e.style.border="2px solid grey",e.style.padding=".5em",e.style.cursor="pointer";{const i=[{tag:"share link",fn:async l=>{await navigator.clipboard.writeText(location.origin+"?"+t.path().tostring().replace("#","")),l.textContent="copied."}},{tag:`expand note ${t.path().tostring()}`,fn:async l=>{window.location.search=t.path().tostring().replace("#","")}},{tag:"rename note",fn:async l=>{$e(t.content.data.Path).catch(()=>{}).then(a=>{a&&t.rename(a)})}}];for(let{tag:l,fn:a}of i){let o=document.createElement("p");o.textContent=l,o.addEventListener("click",r=>a(o)),o.style.padding=".2em",e.append(o)}}let n=document.querySelector("#page");n==null||n.appendChild(e),window.addEventListener("click",()=>e.remove()),e.addEventListener("mouseleave",()=>e.remove())}let Ce=new WeakMap,ce=0;function K(s){return Ce.get(s)}class Y{constructor(t,e,n=!1){_(this,"name","");_(this,"parent");_(this,"element");_(this,"open");_(this,"child");_(this,"path");_(this,"linenumber",null);for(let i of t.split(".").slice(-1)[0].split(":").slice(1))/^[0-9]+$/.test(i)&&(this.linenumber=+i);this.name=t,this.parent=e,this.element=document.createElement("span"),this.element.textContent=t,this.element.classList.add("link"),this.element.spellcheck=!1,this.open=n,this.element.addEventListener("click",()=>{this.set_open(!this.open)}),ce++,this.element.id=`L${ce}`,Ce.set(this.element,this),this.path=this.parent.path().create_child(this.name)}set_path(t){console.log("renaming link",t.tostring(),this.parent.path().tostring()),this.path=t,this.name=t.relative_path_string(this.parent.path()),console.log("new name:",this.name),this.element.textContent=this.name}set_collapsed(t){this.open||this.path.get_language()!="txt"||(t?this.element.textContent=this.path.collapsed_link_name(this.parent.path()):this.element.textContent=this.name)}remove(){var t;(t=this.child)==null||t.remove()}set_open(t){var e;if(t!=this.open){if(this.element.classList.toggle("open"),t){this.set_collapsed(!1);let n=this.element.parentElement;if(this.child=this.parent.create_child(this.path,this),this.linenumber!=null){console.log(this.linenumber);let i=this.child.content.element.childNodes.item(this.linenumber-1);i.style.background="var(--focus)"}((e=n.textContent)==null?void 0:e.trim())==this.name&&this.path.get_language()!="csv"&&this.element.remove(),n.append(this.child.element)}else this.element.parentElement==null&&this.child.element.replaceWith(this.element),this.child.remove();this.open=t,this.parent.content&&this.parent.content.save_linkstate()}}}class ae{constructor(t){_(this,"element");_(this,"editable");let e=t.split("#");console.log(t);let n=decodeURI(e[1]);t=e[0],this.editable=!1,this.element=document.createElement("img"),this.element.classList.add("image"),this.element.src=t,this.element.style.width=n,document.addEventListener("click",i=>{i.target!=this.element&&i.target!=this.element.parentElement&&this.set_sizable(!1)}),this.element.addEventListener("dblclick",()=>{this.set_sizable(!0)})}set_sizable(t){var e;if(t){let n=document.createElement("div");this.element.replaceWith(n),n.style.width=this.element.style.width,this.element.style.width="100%",n.appendChild(this.element),n.style.resize="both",n.style.overflow="auto",n.style.border="2px solid white"}else if(this.editable){let n=this.element.width;this.element.style.width=`min(${n}px, 100%)`,(e=this.element.parentElement)==null||e.replaceWith(this.element)}this.editable=t}}function Ge(s){console.log("create image",s);const t=new ae("");return qe(crypto.randomUUID(),s).then(e=>t.element.src=e),t}function ee(s){for(;s&&!(s.classList&&s.classList.contains("content"));)s=s.parentNode;return s}let Q=null;function Qe(s){s.can_edit&&(Q&&Q.set_editable(!1),s&&s.set_editable(!0),Q=s)}window.addEventListener("click",s=>{let t=ee(s.target);if(t){let e=$(t);Qe(e)}});class Ne{constructor(t){_(this,"note");_(this,"element");_(this,"data");_(this,"saves_pending");_(this,"can_edit");this.note=t,this.element=document.createElement("div"),this.element.classList.add("content"),t.element.append(this.element),this.data=N.getitem(t.path(),e=>{this.set_data(e)}),this.set_data(this.data),this.element.addEventListener("keydown",e=>{var n,i;if(e.shiftKey&&e.key=="Enter"){let l=(i=(n=window.getSelection())==null?void 0:n.anchorNode)==null?void 0:i.parentElement;if(j(l)){let a=K(l);a==null||a.set_open(!a.open),e.preventDefault()}}}),he++,this.element.id=`C${he}`,te.set(this.element,this),this.saves_pending=!1,this.can_edit=this.data.Path.author==z(le)}set_editable(t){this.can_edit&&(this.element.contentEditable=String(t),this.element.focus())}set_data(t){throw"not implemented"}on_input(t){}get_text(){let t=[];for(let e of this.element.children)e.nodeName=="P"&&t.push(this.get_line_text(e));return t.join(`
`)}save(){this.data.Content=this.get_text(),this.saves_pending=!1,N.setitem(this.data)}save_linkstate(){let t=[];this.get_links().forEach(e=>t.push(e.open)),N.set_linkstate(this.note.path(),t),console.log(t)}save_lazy(){this.saves_pending||(this.saves_pending=!0,setTimeout(()=>{this.saves_pending&&this.save()},1e3))}get_links(){let t=[];return this.element.childNodes.forEach(e=>{e.nodeName=="P"&&e.childNodes.forEach(n=>{if(j(n)){let i=K(n);i&&t.push(i)}else if(de(n)){let i=$(n.querySelector(".content"));i!=null&&i.note.creator&&!i.note.creator.element.parentElement&&t.push(i.note.creator)}})}),console.log(t),t}get_line_text(t){let e="";return t.childNodes.forEach(n=>{var i;if(j(n)){let l=n;K(l)==null?e+="":e+=l.textContent}else if(de(n)){let l=(i=$(n.querySelector(".content")))==null?void 0:i.note.creator;l&&!l.element.parentElement&&(e+=l.name)}else if(n.classList&&n.classList.contains("image")){let l=n;console.log(l==null?void 0:l.style.width),e+=`##image:${l==null?void 0:l.src}#${encodeURI(l==null?void 0:l.style.width)}`,console.log(e)}else n.classList&&n.classList.contains("youtubeplayer")?e+=n.src:(n.nodeName=="#text"||n.nodeName=="SPAN")&&(e+=n.textContent)}),e}make_word(t){return new Text(t)}make_line(t,e=!0){if(t==""){let a=document.createElement("p");return a.innerHTML="<br>",a}t=t.replaceAll(" "," "),t=t.replace(/(\S)\u00A0(\S)/g,"$1 $2");let n=t.split(/([\s+[\]{}(),])/),i=document.createElement("p"),l=[];for(let a in n){let o=n[a];if(U(o)&&(!o.startsWith(".")||/\s+| | /.test(n[+a-1])||n[+a-1]==null))try{const r=new Y(o,this.note);l.push(r.element)}catch(r){console.log("failed link",o,r),l.push(this.make_word(o))}else if(ve(o))be(o)?l.push(ke(o)):l.push(Ee(o));else if(o.startsWith("##image:")){const r=new ae(t.slice(8));l.push(r.element);break}else l.push(this.make_word(o))}return l.forEach(a=>{i.appendChild(a)}),i}}let te=new WeakMap,he=0;function j(s){return s instanceof HTMLElement&&s.classList.contains("link")}function de(s){return s instanceof HTMLElement&&s.classList.contains("note")}function $(s){return console.log(te),te.get(s)}function R(s,t){var i,l;let e=s.firstChild;for(;t>((i=e==null?void 0:e.textContent)==null?void 0:i.length);)t-=(l=e==null?void 0:e.textContent)==null?void 0:l.length,e=e==null?void 0:e.nextSibling;let n=null;return e!=null&&(e.nodeName=="SPAN"?(n=e,e=e.firstChild):n=e),Ze(e,t),n}function Ze(s,t){var e=document.createRange(),n=window.getSelection();try{e.setStart(s,t),e.collapse(!0)}catch{}n!=null&&(n.removeAllRanges(),n.addRange(e))}class et extends Ne{constructor(e){var d;super(e);_(this,"table");_(this,"rows");_(this,"columns");this.element.innerHTML="",this.element.contentEditable="false",this.element.style.padding="0";let n=document.createElement("div"),i=document.createElement("div");(d=this.note.head)==null||d.element.remove(),n.classList.add("tablecontainer"),i.classList.add("supercontainer"),this.table=document.createElement("table"),this.table.classList.add("tablecontent");let l=this.data.Content.split(`
`).map(c=>this.make_line(c,!0));console.log("creating table",this.data.Content),this.table.append(...l),this.rows=this.table.childNodes.length,this.columns=this.table.childNodes[0].childNodes.length,this.element.innerHTML="",this.element.replaceWith(i),this.element=i;const a=document.createElement("tr");for(var o=0;o<this.columns;o++)o==0?a.append(document.createElement("span")):a.append(this.removecolumn(this.table,o));this.table.prepend(a),i.append(n),n.append(this.table);const r=document.createElement("button");r.addEventListener("click",c=>{this.table.childNodes.forEach((f,w)=>{let h;w==0?h=this.removecolumn(this.table,this.columns):(h=document.createElement("td"),h.append(super.make_line("")),console.log(h)),f.appendChild(h)}),this.columns++}),r.classList.add("newcolumn"),r.innerHTML="+",n.appendChild(r);const p=document.createElement("button");p.addEventListener("click",c=>{this.table.insertRow(-1).replaceWith(this.make_line(",".repeat(this.columns-2)))}),p.innerHTML="+",p.classList.add("newrow"),i.append(p),this.element.addEventListener("click",c=>{var w;let f=c.target;if(f.nodeName!="BUTTON"&&(f.nodeName=="TD"||((w=f.parentNode)==null?void 0:w.nodeName)=="TD")){let h=c.target.nodeName=="TD"?c.target:c.target.parentNode;h.contentEditable="true";let m=h.querySelector("p");if([m,m.parentElement].includes(document.activeElement))return;m.focus(),R(m,this.get_line_text(m).length)}}),this.element.addEventListener("input",c=>{var f;(c.target.nodeName=="TD"||((f=c.target.parentNode)==null?void 0:f.nodeName)=="TD")&&this.on_input(c)})}set_data(e){}removecolumn(e,n){let i=document.createElement("td"),l=document.createElement("span");return l.innerHTML="-",l.addEventListener("click",a=>{console.log("remove col",n),e.childNodes.forEach((o,r)=>o.childNodes[n].remove())}),this.save_lazy(),l.style.width="100%",i.style.padding="0",i.append(l),i.classList.add("removecolumn"),i.style.border="unset",i}make_line(e,n){const i=document.createElement("tr");i.append(this.removerow(i));for(let l of e.split(",")){let a=document.createElement("td");a.append(super.make_line(l)),i.append(a)}return i}removerow(e){let n=document.createElement("button");return n.innerHTML="-",n.addEventListener("click",()=>e.remove()),n.classList.add("removerow"),n}get_text(){const e=this.element.querySelector("table");let n="";for(let i=1;i<e.childNodes.length;i++){const l=e==null?void 0:e.childNodes[i];for(let a=1;a<l.childNodes.length;a++){const o=l.childNodes[a];console.log(o);let r=this.get_line_text(o.querySelector("p"));n+=r+","}n=n.slice(0,-1)+`
`}return n=n.slice(0,-1),console.log(n),n}async on_input(e){this.save_lazy()}}class ne extends Ne{constructor(e){super(e);_(this,"on_paste",e=>{for(var n=e.target;n.nodeName!="DIV";)if(n=n.parentElement,n==null)return;if(n!=this.element)return;const i=e.clipboardData;for(var l=0;l<i.items.length;l++)if(i.items[l].type.indexOf("image")!==-1){var a=i.items[l].getAsFile();if(a){const r=Ge(a);this.insert_text(r.element)}}let o=e.clipboardData.getData("text");if(o=Ve(o),o.startsWith(window.location.origin)&&o.includes("?")){console.log("pasting link"),e.preventDefault();let r=o.split("?")[1];U(r)||(r="#"+r);const p=new Y(r,this.note,!1);this.insert_text(p.element)}else console.log("pasting normal text",o),e.preventDefault(),this.insert_text(document.createTextNode(o)),o.includes(`
`)&&this.get_text();this.save_lazy()});this.element.addEventListener("keydown",i=>{i.key=="Tab"&&i.target==this.element&&(i.preventDefault(),this.insert_text(document.createTextNode("  ")))}),this.element.addEventListener("input",i=>{var o;let l=ee((o=window.getSelection())==null?void 0:o.focusNode),a=$(l);a==null||a.on_input(i)}),this.element.addEventListener("paste",this.on_paste),this.element.contentEditable=="false"&&this.element.addEventListener("mousedown",i=>{if(ee(i.target)!=this.element)return;let a=i.target;if(j(a)||["H2"].includes(a.nodeName)||a.classList.contains("runbutton"))return;let o=new Le(this.data.Path.pub,z(le),this.data.Path.location),r=window.prompt(`to edit ${this.data.Path.author}'s note you need to make a copy`,o.tostring());r!=null&&this.note.rename(H(r))});let n=N.get_linkstate(e.path());this.get_links().forEach((i,l)=>{n[l]&&!this.note.call_hist.includes(i.path)&&i.set_open(!0)})}set_data(e){this.element.innerHTML="",this.data=e,this.setText(this.data.Content)}setText(e){let n=e.split(`
`);for(let i of n)this.element.append(this.make_line(i))}on_input(e){var p,d,c,f,w,h,m,y,g,v;if(e.type=="input"&&["¨"].includes(e.data))return;const n=window.getSelection(),i=n==null?void 0:n.focusNode;var l=n==null?void 0:n.focusOffset,a;if(i.nodeName=="P")a=i;else if(i.nodeName=="DIV")a=i.firstChild,a==null&&(a=document.createElement("p"),i.appendChild(a));else if(((p=i.parentElement)==null?void 0:p.nodeName)=="P")a=i.parentElement;else if(((c=(d=i.parentElement)==null?void 0:d.parentElement)==null?void 0:c.nodeName)=="P")a=(f=i.parentElement)==null?void 0:f.parentElement;else{this.element.childNodes.forEach(u=>{if(u.nodeName!="P"){const k=document.createElement("p");u.nodeName=="DIV"?(u.replaceWith(k),k.appendChild(u.firstChild)):(u.replaceWith(k),k.appendChild(u)),R(k,0)}});return}if(console.log(a),e.inputType=="insertParagraph"){const u=a.previousElementSibling;((w=u.lastChild)==null?void 0:w.textContent)==""&&((h=u.lastChild)==null||h.remove()),this.reload_line(u),(y=a.firstChild)==null||y.replaceWith((m=a.firstChild)==null?void 0:m.textContent);const k=this.reload_line(a);R(k,0);const x=u.textContent;if(x){const G=(x==null?void 0:x.length)-x.trimStart().length+(["{","[","("].includes(x.slice(-1))?2:0);G&&(this.insert_text(document.createTextNode(" ".repeat(G))),R(k,G))}return}let o=this.get_line_text(a);if(o!=""){let u=i;if(i.nodeName=="P"?(u=i.childNodes[l],l=0):((g=i.parentElement)==null?void 0:g.nodeName)=="SPAN"&&(u=i.parentElement),u==null){console.warn("prev is undefined");return}for(u=u.previousSibling;u!=null;)l+=(v=u.textContent)==null?void 0:v.length,u=u.previousSibling}else l=0;const r=this.reload_line(a,o);R(r,l),this.save_lazy()}reload_line(e,n){n==null&&(n=this.get_line_text(e));const i=this.make_line(n);return e.replaceWith(i),e.childNodes.forEach(l=>{if(j(l)){const a=K(l);a==null||a.remove()}}),i}insert_text(e){const n=window.getSelection();n.deleteFromDocument(),n.getRangeAt(0).insertNode(e),e.parentElement instanceof HTMLBRElement&&(e.parentElement.replaceWith(e),console.log("replaced br")),n.collapseToEnd();const i=document.createRange();i.selectNodeContents(e),i.collapse(!1);const l=window.getSelection();l.removeAllRanges(),l.addRange(i)}}let S=null;window.addEventListener("keydown",s=>{s.ctrlKey&&s.key=="Enter"&&S!=null&&S.runnable&&(S.runbutton.textContent="O",console.log("start running"),S.execute(),S.runbutton.textContent="▶")});class xe extends ne{constructor(e){super(e);_(this,"outfield");_(this,"runnable",!1);_(this,"runbutton",null);this.element.classList.add("js"),this.element.spellcheck=!1,this.data.Path.location[this.data.Path.location.length-1]==this.data.Path.get_language()&&(this.runnable=!0,this.runbutton=document.createElement("div"),this.runbutton.classList.add("runbutton"),this.runbutton.textContent="▶",this.runbutton.contentEditable="false",this.runbutton.addEventListener("click",async n=>{S=this,this.runbutton.textContent="O",await this.execute(),this.runbutton.textContent="▶"}),S==null&&(S=this),this.element.parentElement.append(this.runbutton)),this.outfield=document.createElement("div"),this.outfield.classList.add("content"),this.outfield.contentEditable="false",this.element.parentElement.append(this.outfield)}make_word(e){let n=new Text(e);return nt.forEach(i=>{i.pattern(e)&&(n=document.createElement("span"),n.textContent=e,n.style.color=i.color)}),n}on_input(e){this.runnable&&(S=this),super.on_input(e)}async get_flat_text(e,n){e=e.replaceAll(/print\s*\(/g,"print(");const i=e.split(`
`);let l=[];return[(await Promise.all(i.map(async(o,r)=>{if(/print\s*\(/.test(o)&&(o=o.replaceAll(/print\s*\(/g,`print('${n.data.Path.tostring()}:${r+1}',`)),o.trimStart().startsWith("//"))return;let p=o.split(/([\s+[\]{}(),])/);return(await Promise.all(p.map(async(d,c)=>{if(U(d)&&(!d.startsWith(".")||/\s+| | /.test(p[c-1])||p[c-1]==null)){const f=new Y(d,n.note,!0),w=f.path.tostring().replaceAll(".","$").replaceAll(":","$$$$").replace("#","");return l.push([w,f]),w}return d}))).join("")}))).filter(o=>!(o!=null&&o.startsWith("//"))).join(`
`),l]}async get_content_text(e,n,i){const l=(await N.getitemblocking(n)).Content;let[a,o]=await this.get_flat_text(l,e);for(let[r,p]of o)if(!i.vars.has(r)){i.vars.add(r);const d=new I(p.path,p),c=await this.get_content_text(d.content,p.path,i);i.values.push([r,c])}return a}async execute(){this.save(),this.outfield.innerHTML="",window.print=(...i)=>{this.print(...i)},window.putout=i=>this.outfield.append(i);let e={vars:new Set,values:new Array},n=await this.get_content_text(this,this.data.Path,e);for(let[i,l]of e.values)n=`${i} = ${l};
`+n;console.log(n);try{let l=await Function(`return async()=>{${n}}`)()();console.log(l),this.print(l)}catch(i){console.error(i)}}print(...e){let n=e[0];e=e.slice(1);let i=document.createElement("p");if(n!=null){let l=new Y(n,this.note);l.element.style.float="right",i.append(l.element)}for(let l of e)i.append(Pe(l)),i.append(document.createTextNode(" "));this.outfield.append(i)}}let tt=["abstract","arguments","await","boolean","break","byte","case","catch","char","class","const","continue","debugger","default","delete","do","double","else","enum","eval","export","extends","false","final","finally","float","for","function","goto","if","implements","import","in","instanceof","int","interface","let","long","native","new","null","package","private","protected","public","return","short","static","super","switch","synchronized","this","throw","throws","transient","true","try","typeof","var","void","volatile","while","with","yield"];function Pe(s){console.log("parse",s);let t=i=>["string","number","boolean","symbol","undefined","function"].includes(typeof i)||i==null,e=document.createElement("span"),n=s.constructor.name;if(t(s)){["number","boolean"].includes(typeof s)&&(e.style.color="orange");let i=String(s);e.textContent=i}else{let i=function(){l=!0,a=document.createElement("p"),a.style.paddingLeft="2em",e.append(a);for(let p of Object.keys(s))a.append(p,": "),a.append(Pe(s[p])),a.append(document.createElement("br"))};n+=` [${Object.keys(s).length}]`,e.style.color="var(--blue)",e.style.cursor="pointer";let l=!1,a;e.addEventListener("click",p=>{if(p.target==e){if(l){a==null||a.remove(),l=!1;return}i()}});let o=[];for(let p of Object.keys(s)){if(o.length>3){o.push("...");break}let d="";s instanceof Array||(d+=p+": "),d+=s[p],o.push(d)}let r=document.createElement("span");r.textContent=o.join(", "),r.style.color="var(--color)",e.textContent=n+" ",e.append(r)}return e}const nt=[{pattern:s=>/[\[\]{}()]/.test(s),color:"yellow"},{pattern:s=>tt.includes(s),color:"lightblue"},{pattern:s=>!isNaN(parseFloat(s)),color:"orange"},{pattern:s=>/^"(.*)"/.test(s),color:"orange"}];let D,O=null,ie=(...s)=>{O==null||O.print(...s)};async function it(){console.log("python setup..."),ie("python setup ..."),await Je(()=>import("https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"),[],import.meta.url),D=await loadPyodide(),O.outfield.innerHTML="",window.pyo=D}let st=["False","await","else","import","pass","None","break","except","in","raise","True","class","finally","is","return","and","continue","for","lambda","try","as","def","from","nonlocal","while","assert","del","global","not","with","async","elif","if","or","yield"];const lt=[{pattern:s=>/[\[\]{}()]/.test(s),color:"yellow"},{pattern:s=>st.includes(s),color:"lightblue"},{pattern:s=>!isNaN(parseFloat(s)),color:"orange"},{pattern:s=>/^"(.*)"/.test(s),color:"orange"}];function at(s){let t=new Text(s);return lt.forEach(e=>{e.pattern(s)&&(t=document.createElement("span"),t.textContent=s,t.style.color=e.color)}),t}class ot extends xe{async execute(){this.outfield.innerHTML="";let t=this.get_text();O=this,t=t.replaceAll(" "," ");try{let e=await this.run_python_code(t);e!=null&&ie(e)}catch(e){console.error(e),this.handle_error(e)}}async run_python_code(t){console.log("run python"),D==null&&await it(),await D.loadPackage("micropip");let e=!1;return t=t.split(`
`).map((l,a)=>{if(/^\%pip\s*install/.test(l)){let o=l.split(/^\%pip\s*install/)[1].trim();return e=!0,o=="tinygrad"?`await micropip.install("tinygrad")
await micropip.install("sqlite3")`:`await micropip.install("${o}")`}return l}).join(`
`),e&&(t=`import micropip
`+t),console.log(t),(D==null?void 0:D.globals).set("print",async(...l)=>await this.print(...l)),D.runPythonAsync(t)}make_line(t,e=!0){if(t==""){let a=document.createElement("p");return a.innerHTML="<br>",a}t=t.replaceAll(" "," "),t=t.replace(/(\S)\u00A0(\S)/g,"$1 $2");let n=t.split(/([\s+[\]{}(),])/),i=document.createElement("p"),l=[];for(let a in n){let o=n[a];if(ve(o))be(o)?l.push(ke(o)):l.push(Ee(o));else if(o.startsWith("##image:")){const r=new ae(t.slice(8));l.push(r.element);break}else l.push(this.make_word(o))}return l.forEach(a=>{i.appendChild(a)}),i}handle_error(t){let e=t.stack.split(`
`);console.log(e),e.filter(n=>n.startsWith('  File "<exec>", line')||!n.startsWith(" ")&&!n.startsWith("PythonError:")).map(n=>ie(n))}on_input(t){this.data.Path.location.indexOf("py")==this.data.Path.location.length-1&&(O=this),super.on_input(t)}make_word(t){return at(t)}print(...t){console.log("printing",t);let e=document.createElement("p");e.style.whiteSpace="pre";for(let n of t)e.append(String(n));this.outfield.append(e)}}class I{constructor(t,e){_(this,"creator");_(this,"element");_(this,"head");_(this,"content");_(this,"language");_(this,"call_hist",[]);_(this,"init_path");this.init_path=t,console.log("creating note",t),this.creator=e,this.element=document.createElement("div"),this.element.classList.add("note"),this.head=new rt(this,t),this.element.append(this.head.element),this.language=t.get_language(),this.language=="txt"?this.content=new ne(this):this.language=="js"?this.content=new xe(this):this.language=="py"?this.content=new ot(this):this.language=="csv"?(console.log("creating csv"),this.content=new et(this)):this.content=new ne(this),e&&(this.call_hist=e.parent.call_hist.concat(e.parent.path()))}path(){try{return this.content.data.Path}catch{return this.init_path}}remove(){var t,e;this.content.save(),this.content.save_linkstate(),this.creator&&!((t=this.creator)!=null&&t.element.parentElement)&&this.element.replaceWith((e=this.creator)==null?void 0:e.element),this.element.remove()}create_child(t,e){return new I(t,e)}rename(t){let e=N.getitem(t,i=>{this.content.data.id=i.id,this.content.save()});this.content.data.Path=t,this.content.data.id=e.id,this.content.get_links().forEach(i=>{i.set_path(i.path)}),this.content.save();let n=new I(this.path(),this.creator);this.element.replaceWith(n.element),this.creator?(this.creator.set_path(t),this.creator.child=n,this.creator.parent.content.save()):window.location.search=t.tostring().replace("#","")}}class rt{constructor(t,e){_(this,"note");_(this,"element");this.note=t,this.element=document.createElement("div"),this.element.classList.add("head"),this.element.contentEditable="false";let n=document.createElement("h2"),i;this.note.creator?i=e.title_string(this.note.creator.parent.path()):i=e.title_string(),n.textContent=i,this.element.append(n),this.note.element.append(this.element),this.element.addEventListener("click",l=>{var a;console.log(t),t.creator||console.log("no creator here"),(a=this.note.creator)==null||a.set_open(!1)}),this.element.addEventListener("contextmenu",l=>{Xe(l,this.note)})}}var B=new Map,Z=[],se=!1;function ct(){for(let s=0;s<localStorage.length;s++){const t=localStorage.key(s);try{const e=JSON.parse(t);e.location&&ht(e)}catch{}}}function ht(s){const t=(s.pub?"":"_")+s.location.join(".")+":"+s.author,e=B.size;B.set(t,s),e!=B.size&&(se=!0)}function dt(){return se&&(Z=Array.from(B),Z.sort((s,t)=>s[0].localeCompare(t[0])),se=!1),Z}function pt(){const s=prompt("enter openai key");s&&Ke.set(s)}const ut={tags:["openai","ai","gpt"],rep:"⚙️ add openai key",executor:pt};function Te(s,t){return typeof s=="string"?s.startsWith(t):typeof s=="function"?s(t):s.reduce((e,n)=>e||Te(n,t),!1)}let mt=[{tags:["account","login","signup","sign in","log out","sign out","user account"],rep:"⚙️ account settings",executor:()=>{window.location.pathname="login"}},ut],Se;function ft(){let s=dt().map(t=>{const e=decodeURI(t[0]).replaceAll("_"," ").trimStart(),n=(t[1].pub?"📃 ":"🔒 ")+e.replace(":"," by ");return{tags:e,rep:n,executor:()=>{const l=new Le(t[1].pub,t[1].author,t[1].location).tostring();window.location.search=l.replace("#",""),V.update(a=>(a[n]=Date.now(),a)),console.log(z(V))}}}).sort((t,e)=>(z(V)[e.rep]??0)-(z(V)[t.rep]??0));Se=mt.concat(...s)}function gt(s,t=10){return Se.filter(n=>Te(n.tags,s)).slice(0,t)}function pe(s,t,e){const n=s.slice();return n[11]=t[e],n[13]=e,n}function _t(s){let t,e,n,i;return{c(){t=P("button"),e=F("⚙︎"),this.h()},l(l){t=T(l,"BUTTON",{id:!0});var a=M(t);e=q(a,"⚙︎"),a.forEach(b),this.h()},h(){L(t,"id","search_btn")},m(l,a){C(l,t,a),E(t,e),n||(i=X(t,"click",s[7]),n=!0)},p:J,d(l){l&&b(t),n=!1,i()}}}function wt(s){let t,e,n,i;return{c(){t=P("span"),e=F(">> Cmd + P"),this.h()},l(l){t=T(l,"SPAN",{id:!0});var a=M(t);e=q(a,">> Cmd + P"),a.forEach(b),this.h()},h(){L(t,"id","search_btn")},m(l,a){C(l,t,a),E(t,e),n||(i=X(t,"click",s[6]),n=!0)},p:J,d(l){l&&b(t),n=!1,i()}}}function ue(s){let t,e=(typeof s[11].rep=="string"?s[11].rep:s[11].rep(s[2]))+"",n,i,l,a,o,r;function p(){return s[10](s[11])}return{c(){t=P("p"),n=F(e),l=A(),a=P("br"),this.h()},l(d){t=T(d,"P",{class:!0});var c=M(t);n=q(c,e),c.forEach(b),l=W(d),a=T(d,"BR",{}),this.h()},h(){L(t,"class",i=s[13]==s[4]?"highlighted":"")},m(d,c){C(d,t,c),E(t,n),C(d,l,c),C(d,a,c),o||(r=X(t,"click",p),o=!0)},p(d,c){s=d,c&12&&e!==(e=(typeof s[11].rep=="string"?s[11].rep:s[11].rep(s[2]))+"")&&ye(n,e),c&16&&i!==(i=s[13]==s[4]?"highlighted":"")&&L(t,"class",i)},d(d){d&&b(t),d&&b(l),d&&b(a),o=!1,r()}}}function yt(s){let t,e,n,i,l,a,o,r,p,d,c;function f(g,v){return g[5]?wt:_t}let w=f(s),h=w(s),m=s[3],y=[];for(let g=0;g<m.length;g+=1)y[g]=ue(pe(s,m,g));return{c(){h.c(),t=A(),e=P("div"),n=P("p"),i=F(me),l=A(),a=P("input"),o=A(),r=P("div");for(let g=0;g<y.length;g+=1)y[g].c();this.h()},l(g){h.l(g),t=W(g),e=T(g,"DIV",{class:!0});var v=M(e);n=T(v,"P",{id:!0});var u=M(n);i=q(u,me),u.forEach(b),l=W(v),a=T(v,"INPUT",{placeholder:!0,type:!0}),o=W(v),r=T(v,"DIV",{class:!0});var k=M(r);for(let x=0;x<y.length;x+=1)y[x].l(k);k.forEach(b),v.forEach(b),this.h()},h(){L(n,"id","searchsuggestion"),L(a,"placeholder","search..."),L(a,"type","text"),L(r,"class","results"),L(e,"class","searchbar"),e.hidden=p=!s[0]},m(g,v){h.m(g,v),C(g,t,v),C(g,e,v),E(e,n),E(n,i),E(e,l),E(e,a),s[8](a),oe(a,s[2]),E(e,o),E(e,r);for(let u=0;u<y.length;u+=1)y[u].m(r,null);d||(c=X(a,"input",s[9]),d=!0)},p(g,[v]){if(w===(w=f(g))&&h?h.p(g,v):(h.d(1),h=w(g),h&&(h.c(),h.m(t.parentNode,t))),v&4&&a.value!==g[2]&&oe(a,g[2]),v&28){m=g[3];let u;for(u=0;u<m.length;u+=1){const k=pe(g,m,u);y[u]?y[u].p(k,v):(y[u]=ue(k),y[u].c(),y[u].m(r,null))}for(;u<y.length;u+=1)y[u].d(1);y.length=m.length}v&1&&p!==(p=!g[0])&&(e.hidden=p)},i:J,o:J,d(g){h.d(g),g&&b(t),g&&b(e),s[8](null),Ae(y,g),d=!1,c()}}}let me="";function vt(s,t,e){let n=!1,i="",l=[],a=0;window.addEventListener("keydown",h=>{h.key=="p"?h.metaKey&&(h.preventDefault(),e(0,n=!0)):h.key=="Escape"&&e(0,n=!1)}),window.addEventListener("keyup",h=>{if(n&&!(h.key=="Meta"||h.key=="Escape"))if(h.key=="ArrowUp")e(4,a=Math.max(a-1,0));else if(h.key=="ArrowDown")e(4,a=Math.min(a+1,l.length-1));else if(h.key=="Tab"){h.preventDefault();let m=l[a].tags;typeof m=="string"&&(m=m.split(":")[0],m=m.split(".").slice(0,i.split(".").length).join("."),e(2,i=m),o.focus())}else if(h.key=="Enter")l[a].executor(i);else{if(i==""){e(3,l=[]);return}e(4,a=0),e(3,l=gt(i)),l.length==0&&e(3,l=[{tags:m=>!0,rep:m=>`⚙️ create Page: ${m}`,executor:m=>{const y=new I(H("#"+m));N.setitem(y.content.data),window.location.search=m}},{tags:m=>!0,rep:m=>`⚙️ create secret Page: ${m}`,executor:m=>{const y=new I(H("_"+m));N.setitem(y.content.data),window.location.search="_"+m}}]),l[0]}}),window.addEventListener("click",h=>{h.target.id!="search_btn"&&(e(0,n=!1),e(5,r=!1))});let o,r=!1;const p=()=>{e(5,r=!1),e(0,n=!0)},d=h=>{e(5,r=!0)};function c(h){We[h?"unshift":"push"](()=>{o=h,e(1,o)})}function f(){i=this.value,e(2,i)}const w=h=>{h.executor(i)};return s.$$.update=()=>{s.$$.dirty&3&&n&&(ft(),we().then(()=>{o.focus()}))},[n,o,i,l,a,r,p,d,c,f,w]}class bt extends fe{constructor(t){super(),ge(this,t,vt,yt,_e,{})}}function kt(s){let t,e,n,i,l,a=s[1]?"":"offline",o,r,p,d;return t=new bt({}),{c(){He(t.$$.fragment),e=A(),n=P("h2"),i=new Ie(!1),l=A(),o=F(a),r=A(),p=P("div"),this.h()},l(c){Oe(t.$$.fragment,c),e=W(c),n=T(c,"H2",{id:!0});var f=M(n);i=Re(f,!1),l=W(f),o=q(f,a),f.forEach(b),r=W(c),p=T(c,"DIV",{id:!0});var w=M(p);w.forEach(b),this.h()},h(){i.a=l,L(n,"id","fullheader"),L(p,"id","page")},m(c,f){ze(t,c,f),C(c,e,f),C(c,n,f),i.m(s[0],n),E(n,l),E(n,o),C(c,r,f),C(c,p,f),d=!0},p(c,[f]){(!d||f&1)&&i.p(c[0]),(!d||f&2)&&a!==(a=c[1]?"":"offline")&&ye(o,a)},i(c){d||(je(t.$$.fragment,c),d=!0)},o(c){Ue(t.$$.fragment,c),d=!1},d(c){Fe(t,c),c&&b(e),c&&b(n),c&&b(r),c&&b(p)}}}function Et(s,t,e){let n,i;re(s,le,w=>e(7,n=w)),re(s,Be,w=>e(1,i=w));let{data:l}=t;document.title=window.location.hostname.split(".")[0]+(window.location.search?" | "+window.location.search.slice(1).split(":")[0]:"");var a,o="<br>";a=`<a href=/ onclick="window.location.href = '${window.origin}'; location.reload();" id=homebtn>sciepedia</a>`,o=a,we().then(f);let r;const p=`Click me and write something: xzxysl ... &^

You can create a new link with # followed by text, for example: #link #recursion #whatever

Click on a link to open a page. If the page already exists, it will be displayed to you.

Almost forgot! Create an account: {}/login, and then you can create public pages.

If you want to learn more, check out: #sciepedia:kormann
`;let d,c=H("_home:"+n);async function f(){if(ct(),window.fetch=l.fetch,r=document.createElement("div"),r.innerHTML="<p>this is a pred</p><p>this is a pred</p><p>this is a pred</p>",r.id="pred",a=`<a href=/ onclick="setTimeout(()=>{window.location.href='${window.origin}'})" id=homebtn>sciepedia</a>`,e(0,o=a),!N.has(c)){const y={Path:c,Content:`welcome to #sciepedia:kormann
if you're new try out the tutorial: _tutorial`,id:crypto.randomUUID()};localStorage[JSON.stringify(y.Path)]=JSON.stringify(y)}const w=H("_tutorial:"+n);N.has(w)||N.setitem({Path:w,Content:p.replace("{}",window.location.origin),id:crypto.randomUUID()});let h=window.location.search;h&&h.length>1&&(h=decodeURI(h.slice(1)),U(h)||(h="#"+h),console.log("searching:",h),U(h)&&(c=H(h))),d=document.querySelector("#page");let m=new I(c);d.appendChild(m.element),window.addEventListener("onunload",y=>{localStorage.unloading=!0,m.remove(),localStorage.unloaded=!0})}return s.$$set=w=>{"data"in w&&e(2,l=w.data)},[o,i,l]}class Tt extends fe{constructor(t){super(),ge(this,t,Et,kt,_e,{data:2})}}export{Tt as component,Pt as universal};
