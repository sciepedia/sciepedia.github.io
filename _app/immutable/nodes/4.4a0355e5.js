var z=Object.defineProperty;var F=(s,e,t)=>e in s?z(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var p=(s,e,t)=>(F(s,typeof e!="symbol"?e+"":e,t),t);import{S as G,i as Q,s as Y,k as _,q as J,a as T,l as y,m as x,r as D,h as c,c as L,n as h,b,C as f,D as B,o as Z}from"../chunks/index.c24d3119.js";class k{constructor(e,t){p(this,"value");p(this,"subscribers");p(this,"key");p(this,"hash");localStorage.getItem(e)===null?localStorage.setItem(e,JSON.stringify(t)):t=JSON.parse(localStorage.getItem(e)),this.value=t,this.subscribers=[],this.key=e,this.hash=JSON.stringify(t)}set(e){this.hash!=JSON.stringify(e)&&(this.value=e,localStorage.setItem(this.key,JSON.stringify(e)),this.subscribers.forEach(t=>t(e)))}subscribe(e){this.subscribers.push(e)}update(e){this.set(e(this.value))}}const V="https://chatserver.sciepedia.com/",ee="http://localhost:5000/";let X=V;window.location.hostname==="localhost"&&(X=ee);function te(s,e){return new Promise((i,a)=>{let o=s.map(n=>({content:n.content,role:n.role}));fetch(X+"answer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:o})}).then(n=>{console.log(n);let r=n.body.getReader();function w({done:d,value:C}){if(d){i();return}e(new TextDecoder().decode(C)),r.read().then(w)}r.read().then(w)})})}let H,m,A,R,v=new k("last_message",""),U=new k("history",[]);const K=new Map;class M{constructor(e){p(this,"msg");p(this,"element");this.msg=e,this.element=document.createElement("div"),this.element.classList.add("message"),this.element.classList.add(e.value.role),this.setContent(e.value.content),H.appendChild(this.element),e.subscribe(t=>{this.setContent(t.content)})}setContent(e){this.element.innerHTML="";let t=document.createElement("div");t.classList.add("text"),this.element.appendChild(t);let i=0;e.split(`
`).forEach(a=>{if(a.startsWith("```")){i=(i+1)%2,t=document.createElement("div");let o=["text","code"][i];t.classList.add(o),this.element.appendChild(t)}else t.textContent+=a+`
`})}}function O(){return Math.random().toString(36).slice(-8)}function se(s){new M(new k("M_"+O(),{role:"user",content:s,parent_key:"",key:"",child_keys:[]}));let e=s.slice(1),t=e.split(" ");e=t[0],t.slice(1),new M(new k("M_"+O(),{role:"assistant",content:"Command received: "+e,parent_key:"",key:"",child_keys:[]}))}function $(s){if(s.startsWith("/"))return se(s);let e="M_"+O(),t=new k(e,{role:"user",content:s,parent_key:v.value,key:e,child_keys:[]});K.set(e,t),new M(t),v.set(e);let i="M_"+O(),a=new k(i,{role:"assistant",content:"...",parent_key:e,key:i,child_keys:[]}),o=[t.value];for(let n=0;n<10;n++){let r=P(o[0].parent_key);if(!r)break;o=[r.value,...o]}te(o,n=>{a.update(r=>(console.log(n),r.content=r.content.slice(0,r.content.length-3)+n+"...",r))}).then(()=>{a.update(n=>(n.content=n.content.slice(0,n.content.length-3),n)),v.set(i)}),new M(a)}function P(s){return s?K.has(s)?K.get(s):new k(s,{role:"system",content:"Message not found",parent_key:"",key:s,child_keys:[]}):null}function ne(){if(H=document.querySelector("#chat"),m=document.querySelector("#inputmask>textarea"),A=document.querySelector("#sendbtn"),R=document.querySelector("#resetbtn"),m.addEventListener("keyup",s=>{if(s.key=="Enter"&&s.shiftKey){$(m.value.slice(0,-1)),m.value="";return}m.rows=m.value.split(`
`).length}),v.value){let s=function(t){t!=null&&(s(P(t.value.parent_key)),new M(t))},e=P(v.value);s(e)}A.addEventListener("click",()=>{$(m.value),m.value=""}),R.addEventListener("click",()=>{U.update(s=>s.concat([v.value])),v.set(""),H.innerHTML="",console.log(U)})}function le(s){let e,t,i,a,o,n,r,w,d,C,I,S,q,N,E;return{c(){e=_("h1"),t=J("chat"),i=T(),a=_("div"),o=T(),n=_("div"),r=_("textarea"),w=T(),d=_("button"),C=J("send"),I=T(),S=_("button"),q=J("reset"),N=T(),E=_("link"),this.h()},l(l){e=y(l,"H1",{});var u=x(e);t=D(u,"chat"),u.forEach(c),i=L(l),a=y(l,"DIV",{id:!0}),x(a).forEach(c),o=L(l),n=y(l,"DIV",{id:!0});var g=x(n);r=y(g,"TEXTAREA",{id:!0,rows:!0}),x(r).forEach(c),w=L(g),d=y(g,"BUTTON",{id:!0});var W=x(d);C=D(W,"send"),W.forEach(c),I=L(g),S=y(g,"BUTTON",{id:!0});var j=x(S);q=D(j,"reset"),j.forEach(c),g.forEach(c),N=L(l),E=y(l,"LINK",{rel:!0,href:!0}),this.h()},h(){h(a,"id","chat"),h(r,"id",""),h(r,"rows","1"),h(d,"id","sendbtn"),h(S,"id","resetbtn"),h(n,"id","inputmask"),h(E,"rel","stylesheet"),h(E,"href","chatstyle.css")},m(l,u){b(l,e,u),f(e,t),b(l,i,u),b(l,a,u),b(l,o,u),b(l,n,u),f(n,r),f(n,w),f(n,d),f(d,C),f(n,I),f(n,S),f(S,q),b(l,N,u),b(l,E,u)},p:B,i:B,o:B,d(l){l&&c(e),l&&c(i),l&&c(a),l&&c(o),l&&c(n),l&&c(N),l&&c(E)}}}function re(s){return Z(ne),document.title="chat",[]}class oe extends G{constructor(e){super(),Q(this,e,re,le,Y,{})}}export{oe as component};
